<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>隨手記帳</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 修正 iOS 輸入框預設樣式 */
        input[type="date"], input[type="month"], input[type="number"], input[type="text"] {
            -webkit-appearance: none;
            appearance: none;
        }

        /* 【關鍵 CSS】當輸入框被點擊(Focus)時，讓提示文字(Placeholder)變透明 */
        input:focus::placeholder {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-[100dvh] w-full overflow-hidden flex flex-col">

<div id="app" class="flex flex-col h-full w-full max-w-md mx-auto bg-white shadow-2xl relative">

    <header class="bg-blue-600 text-white p-4 text-center font-bold shadow-md z-30 shrink-0">
        {{ pageTitle }}
    </header>

    <main class="flex-1 overflow-y-auto p-4 pb-28 no-scrollbar w-full">
        
        <div v-if="currentTab === 'add'" class="space-y-5 fade-in">
            <div class="flex bg-gray-200 p-1 rounded-lg shrink-0">
                <button @click="form.type = 'expense'" :class="{'bg-white text-red-500 shadow': form.type === 'expense'}" class="flex-1 py-2 rounded-md transition-all font-bold text-sm">支出</button>
                <button @click="form.type = 'income'" :class="{'bg-white text-green-500 shadow': form.type === 'income'}" class="flex-1 py-2 rounded-md transition-all font-bold text-sm">收入</button>
            </div>

            <div class="text-center py-2">
                <label class="block text-xs text-gray-500 mb-1">金額</label>
                <input type="number" v-model.number="form.amount" placeholder="0" class="text-5xl font-bold text-center w-full outline-none bg-transparent border-b-2 border-blue-200 focus:border-blue-500 py-2 transition-colors input-mode-decimal">
            </div>

            <div class="space-y-3 w-full">
                <div class="w-full">
                    <label class="block text-xs text-gray-500 mb-1">日期</label>
                    <input type="date" v-model="form.date" class="w-full min-w-0 p-3 bg-gray-50 rounded-lg border border-gray-200 outline-none focus:border-blue-500 text-sm">
                </div>
                <div class="w-full">
                    <label class="block text-xs text-gray-500 mb-1">備註 (選填)</label>
                    <input type="text" v-model="form.note" placeholder="例如：午餐、薪水..." class="w-full min-w-0 p-3 bg-gray-50 rounded-lg border border-gray-200 outline-none focus:border-blue-500 text-sm">
                </div>
            </div>

            <div>
                <label class="block text-xs text-gray-500 mb-2">選擇分類</label>
                <div class="grid grid-cols-4 gap-2">
                    <div v-for="cat in categories" :key="cat" 
                         @click="form.category = cat"
                         :class="{'bg-blue-100 border-blue-500 text-blue-700': form.category === cat, 'bg-gray-50 border-gray-200': form.category !== cat}"
                         class="p-2 text-center text-xs rounded-lg border cursor-pointer select-none transition-all truncate">
                        {{ cat }}
                    </div>
                </div>
            </div>

            <button @click="addTransaction" :disabled="!isValidForm" 
                    class="w-full py-3.5 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                儲存紀錄
            </button>
        </div>

        <div v-if="currentTab === 'list'" class="space-y-4">
            <div class="flex gap-2 sticky top-0 bg-white z-20 py-2 border-b">
                <input type="month" v-model="filterDate" class="w-1/3 min-w-0 p-2 border rounded-lg text-xs bg-gray-50">
                <input type="text" v-model="searchKeyword" placeholder="搜尋備註..." class="flex-1 min-w-0 p-2 border rounded-lg text-xs outline-none focus:border-blue-500 bg-gray-50">
            </div>

            <div v-if="filteredTransactions.length === 0" class="text-center text-gray-400 mt-10">
                <i class="fa-solid fa-receipt text-4xl mb-2"></i>
                <p class="text-sm">沒有相關紀錄</p>
            </div>

            <div v-for="tx in filteredTransactions" :key="tx.id" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div :class="tx.type === 'expense' ? 'bg-red-100 text-red-500' : 'bg-green-100 text-green-500'" class="w-9 h-9 rounded-full flex items-center justify-center shrink-0">
                        <i :class="getCategoryIcon(tx.category)" class="text-sm"></i>
                    </div>
                    <div class="min-w-0">
                        <div class="font-bold text-gray-700 text-sm truncate">{{ tx.category }}</div>
                        <div class="text-xs text-gray-400 truncate">{{ tx.date }} <span v-if="tx.note">· {{ tx.note }}</span></div>
                    </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <div :class="tx.type === 'expense' ? 'text-red-500' : 'text-green-500'" class="font-bold text-base">
                        {{ tx.type === 'expense' ? '-' : '+' }}{{ tx.amount }}
                    </div>
                    <button @click="deleteTransaction(tx.id)" class="text-gray-300 hover:text-red-500 p-1">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'stats'" class="space-y-5">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-green-50 p-3 rounded-xl border border-green-100">
                    <div class="text-xs text-gray-500">本月收入</div>
                    <div class="text-lg font-bold text-green-600 truncate">{{ monthlyStats.income }}</div>
                </div>
                <div class="bg-red-50 p-3 rounded-xl border border-red-100">
                    <div class="text-xs text-gray-500">本月支出</div>
                    <div class="text-lg font-bold text-red-600 truncate">{{ monthlyStats.expense }}</div>
                </div>
            </div>
            
            <div class="bg-blue-50 p-3 rounded-xl text-center border border-blue-100">
                <div class="text-xs text-gray-500">本月淨額</div>
                <div class="text-2xl font-bold text-blue-600">{{ monthlyStats.income - monthlyStats.expense }}</div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100" v-show="monthlyStats.expense > 0">
                <h3 class="font-bold text-gray-700 mb-2 text-center text-sm">支出分類佔比</h3>
                <div class="relative h-56 w-full">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
            <div v-if="monthlyStats.expense === 0" class="text-center text-gray-400 py-10">
                <p class="text-sm">本月尚無支出資料</p>
            </div>
        </div>
    </main>

    <nav class="bg-white border-t border-gray-200 flex justify-around items-center py-2 pb-6 z-30 shrink-0">
        <button @click="currentTab = 'add'" :class="currentTab === 'add' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center w-1/3 transition-colors p-1">
            <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
            <span class="text-[10px]">記帳</span>
        </button>
        <button @click="currentTab = 'list'" :class="currentTab === 'list' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center w-1/3 transition-colors p-1">
            <i class="fa-solid fa-list text-xl mb-1"></i>
            <span class="text-[10px]">明細</span>
        </button>
        <button @click="currentTab = 'stats'" :class="currentTab === 'stats' ? 'text-blue-600' : 'text-gray-400'" class="flex flex-col items-center w-1/3 transition-colors p-1">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
            <span class="text-[10px]">分析</span>
        </button>
    </nav>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            const currentTab = ref('add');
            const transactions = ref([]);
            const searchKeyword = ref('');
            const filterDate = ref(new Date().toISOString().slice(0, 7)); 
            
            const form = ref({
                type: 'expense',
                amount: '',
                date: new Date().toISOString().slice(0, 10),
                category: '飲食',
                note: ''
            });

            const categories = ['飲食', '交通', '娛樂', '購物', '居住', '醫療', '薪水', '投資', '其他'];
            let chartInstance = null;

            onMounted(() => {
                const savedData = localStorage.getItem('my_expense_tracker_data');
                if (savedData) {
                    transactions.value = JSON.parse(savedData);
                }
            });

            watch(transactions, (newVal) => {
                localStorage.setItem('my_expense_tracker_data', JSON.stringify(newVal));
            }, { deep: true });

            watch(currentTab, async (newTab) => {
                if (newTab === 'stats') {
                    await nextTick();
                    renderChart();
                }
            });
            
            watch(filterDate, async () => {
                if (currentTab.value === 'stats') {
                    await nextTick();
                    renderChart();
                }
            });

            const isValidForm = computed(() => {
                return form.value.amount > 0 && form.value.date && form.value.category;
            });

            const pageTitle = computed(() => {
                const map = { add: '新增記帳', list: '交易明細', stats: '收支分析' };
                return map[currentTab.value];
            });

            const filteredTransactions = computed(() => {
                return transactions.value.filter(t => {
                    const matchDate = t.date.startsWith(filterDate.value);
                    const matchSearch = t.note.includes(searchKeyword.value) || t.category.includes(searchKeyword.value);
                    return matchDate && matchSearch;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            const monthlyStats = computed(() => {
                const stats = { income: 0, expense: 0 };
                filteredTransactions.value.forEach(t => {
                    if (t.type === 'income') stats.income += t.amount;
                    else stats.expense += t.amount;
                });
                return stats;
            });

            const addTransaction = () => {
                const newTx = {
                    id: Date.now(),
                    ...form.value
                };
                transactions.value.unshift(newTx);
                
                form.value.amount = '';
                form.value.note = '';
            };

            const deleteTransaction = (id) => {
                if(confirm('確定刪除此筆紀錄？')) {
                    transactions.value = transactions.value.filter(t => t.id !== id);
                }
            };

            const getCategoryIcon = (cat) => {
                const map = {
                    '飲食': 'fa-utensils', '交通': 'fa-bus', '娛樂': 'fa-gamepad',
                    '購物': 'fa-bag-shopping', '居住': 'fa-house', '醫療': 'fa-briefcase-medical',
                    '薪水': 'fa-money-bill-wave', '投資': 'fa-chart-line', '其他': 'fa-circle-question'
                };
                return `fa-solid ${map[cat] || 'fa-tag'}`;
            };

            const renderChart = () => {
                const ctx = document.getElementById('expenseChart');
                if (!ctx) return;

                if (chartInstance) chartInstance.destroy();

                const catStats = {};
                filteredTransactions.value.forEach(t => {
                    if (t.type === 'expense') {
                        catStats[t.category] = (catStats[t.category] || 0) + t.amount;
                    }
                });

                const labels = Object.keys(catStats);
                const data = Object.values(catStats);

                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } }
                        },
                        layout: {
                            padding: 10
                        }
                    }
                });
            };

            return {
                currentTab, transactions, form, categories,
                searchKeyword, filterDate, pageTitle,
                isValidForm, filteredTransactions, monthlyStats,
                addTransaction, deleteTransaction, getCategoryIcon
            };
        }
    }).mount('#app');
</script>
</body>
</html>

