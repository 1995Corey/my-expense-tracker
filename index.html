<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>隨手記帳 MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      body {
        -webkit-tap-highlight-color: transparent;
      }
      /* 隱藏滾動條但保持功能 */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 text-gray-800 h-screen flex flex-col overflow-hidden"
  >
    <div
      id="app"
      class="flex flex-col h-full max-w-md mx-auto bg-white shadow-2xl relative"
    >
      <header
        class="bg-blue-600 text-white p-4 text-center font-bold shadow-md z-10"
      >
        {{ pageTitle }}
      </header>

      <main class="flex-1 overflow-y-auto p-4 pb-20 no-scrollbar">
        <div v-if="currentTab === 'add'" class="space-y-6 fade-in">
          <div class="flex bg-gray-200 p-1 rounded-lg">
            <button
              @click="form.type = 'expense'"
              :class="{'bg-white text-red-500 shadow': form.type === 'expense'}"
              class="flex-1 py-2 rounded-md transition-all font-bold"
            >
              支出
            </button>
            <button
              @click="form.type = 'income'"
              :class="{'bg-white text-green-500 shadow': form.type === 'income'}"
              class="flex-1 py-2 rounded-md transition-all font-bold"
            >
              收入
            </button>
          </div>

          <div class="text-center">
            <label class="block text-sm text-gray-500 mb-1">金額</label>
            <input
              type="number"
              v-model.number="form.amount"
              placeholder="0"
              class="text-4xl font-bold text-center w-full outline-none bg-transparent border-b-2 border-blue-200 focus:border-blue-500 py-2 transition-colors input-mode-decimal"
            />
          </div>

          <div class="space-y-3">
            <div>
              <label class="block text-xs text-gray-500 mb-1">日期</label>
              <input
                type="date"
                v-model="form.date"
                class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 outline-none focus:border-blue-500"
              />
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-1"
                >備註 (選填)</label
              >
              <input
                type="text"
                v-model="form.note"
                placeholder="例如：午餐、薪水..."
                class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 outline-none focus:border-blue-500"
              />
            </div>
          </div>

          <div>
            <label class="block text-xs text-gray-500 mb-2">選擇分類</label>
            <div class="grid grid-cols-4 gap-2">
              <div
                v-for="cat in categories"
                :key="cat"
                @click="form.category = cat"
                :class="{'bg-blue-100 border-blue-500 text-blue-700': form.category === cat, 'bg-gray-50 border-gray-200': form.category !== cat}"
                class="p-2 text-center text-sm rounded-lg border cursor-pointer select-none transition-all truncate"
              >
                {{ cat }}
              </div>
            </div>
          </div>

          <button
            @click="addTransaction"
            :disabled="!isValidForm"
            class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            儲存紀錄
          </button>
        </div>

        <div v-if="currentTab === 'list'" class="space-y-4">
          <div class="flex gap-2 sticky top-0 bg-white z-10 py-2 border-b">
            <input
              type="month"
              v-model="filterDate"
              class="p-2 border rounded-lg text-sm"
            />
            <input
              type="text"
              v-model="searchKeyword"
              placeholder="搜尋備註..."
              class="flex-1 p-2 border rounded-lg text-sm outline-none focus:border-blue-500"
            />
          </div>

          <div
            v-if="filteredTransactions.length === 0"
            class="text-center text-gray-400 mt-10"
          >
            <i class="fa-solid fa-receipt text-4xl mb-2"></i>
            <p>沒有相關紀錄</p>
          </div>

          <div
            v-for="tx in filteredTransactions"
            :key="tx.id"
            class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"
          >
            <div class="flex items-center gap-3">
              <div
                :class="tx.type === 'expense' ? 'bg-red-100 text-red-500' : 'bg-green-100 text-green-500'"
                class="w-10 h-10 rounded-full flex items-center justify-center"
              >
                <i :class="getCategoryIcon(tx.category)"></i>
              </div>
              <div>
                <div class="font-bold text-gray-700">{{ tx.category }}</div>
                <div class="text-xs text-gray-400">
                  {{ tx.date }} <span v-if="tx.note">· {{ tx.note }}</span>
                </div>
              </div>
            </div>
            <div
              :class="tx.type === 'expense' ? 'text-red-500' : 'text-green-500'"
              class="font-bold text-lg"
            >
              {{ tx.type === 'expense' ? '-' : '+' }}{{ tx.amount }}
            </div>
            <button
              @click="deleteTransaction(tx.id)"
              class="text-gray-300 hover:text-red-500 ml-2"
            >
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>

        <div v-if="currentTab === 'stats'" class="space-y-6">
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
              <div class="text-xs text-gray-500">本月收入</div>
              <div class="text-xl font-bold text-green-600">
                {{ monthlyStats.income }}
              </div>
            </div>
            <div class="bg-red-50 p-4 rounded-xl border border-red-100">
              <div class="text-xs text-gray-500">本月支出</div>
              <div class="text-xl font-bold text-red-600">
                {{ monthlyStats.expense }}
              </div>
            </div>
          </div>

          <div
            class="bg-blue-50 p-4 rounded-xl text-center border border-blue-100"
          >
            <div class="text-xs text-gray-500">本月淨額</div>
            <div class="text-2xl font-bold text-blue-600">
              {{ monthlyStats.income - monthlyStats.expense }}
            </div>
          </div>

          <div
            class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"
            v-show="monthlyStats.expense > 0"
          >
            <h3 class="font-bold text-gray-700 mb-4 text-center">
              支出分類佔比
            </h3>
            <div class="relative h-64">
              <canvas id="expenseChart"></canvas>
            </div>
          </div>
          <div
            v-if="monthlyStats.expense === 0"
            class="text-center text-gray-400 py-10"
          >
            本月尚無支出資料
          </div>
        </div>
      </main>

      <nav
        class="bg-white border-t border-gray-200 flex justify-around items-center h-16 pb-safe z-20"
      >
        <button
          @click="currentTab = 'add'"
          :class="currentTab === 'add' ? 'text-blue-600' : 'text-gray-400'"
          class="flex flex-col items-center w-1/3 transition-colors"
        >
          <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
          <span class="text-xs">記帳</span>
        </button>
        <button
          @click="currentTab = 'list'"
          :class="currentTab === 'list' ? 'text-blue-600' : 'text-gray-400'"
          class="flex flex-col items-center w-1/3 transition-colors"
        >
          <i class="fa-solid fa-list text-xl mb-1"></i>
          <span class="text-xs">明細</span>
        </button>
        <button
          @click="currentTab = 'stats'"
          :class="currentTab === 'stats' ? 'text-blue-600' : 'text-gray-400'"
          class="flex flex-col items-center w-1/3 transition-colors"
        >
          <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
          <span class="text-xs">分析</span>
        </button>
      </nav>
    </div>

    <script>
      const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

      createApp({
        setup() {
          // 狀態管理
          const currentTab = ref("add");
          const transactions = ref([]);
          const searchKeyword = ref("");
          const filterDate = ref(new Date().toISOString().slice(0, 7)); // YYYY-MM

          const form = ref({
            type: "expense",
            amount: "",
            date: new Date().toISOString().slice(0, 10),
            category: "飲食",
            note: "",
          });

          const categories = [
            "飲食",
            "交通",
            "娛樂",
            "購物",
            "居住",
            "醫療",
            "薪水",
            "投資",
            "其他",
          ];
          let chartInstance = null;

          // 初始化：讀取 localStorage
          onMounted(() => {
            const savedData = localStorage.getItem("my_expense_tracker_data");
            if (savedData) {
              transactions.value = JSON.parse(savedData);
            }
          });

          // 監聽資料變動 -> 自動儲存
          watch(
            transactions,
            (newVal) => {
              localStorage.setItem(
                "my_expense_tracker_data",
                JSON.stringify(newVal)
              );
            },
            { deep: true }
          );

          // 監聽 Tab 切換 -> 如果是分析頁，更新圖表
          watch(currentTab, async (newTab) => {
            if (newTab === "stats") {
              await nextTick();
              renderChart();
            }
          });

          // 監聽篩選條件變動 -> 更新圖表
          watch(filterDate, async () => {
            if (currentTab.value === "stats") {
              await nextTick();
              renderChart();
            }
          });

          // 計算屬性：表單驗證
          const isValidForm = computed(() => {
            return (
              form.value.amount > 0 && form.value.date && form.value.category
            );
          });

          // 計算屬性：頁面標題
          const pageTitle = computed(() => {
            const map = {
              add: "新增記帳",
              list: "交易明細",
              stats: "收支分析",
            };
            return map[currentTab.value];
          });

          // 計算屬性：過濾後的交易列表 (依日期排序)
          const filteredTransactions = computed(() => {
            return transactions.value
              .filter((t) => {
                const matchDate = t.date.startsWith(filterDate.value);
                const matchSearch =
                  t.note.includes(searchKeyword.value) ||
                  t.category.includes(searchKeyword.value);
                return matchDate && matchSearch;
              })
              .sort((a, b) => new Date(b.date) - new Date(a.date)); // 新的在前
          });

          // 計算屬性：本月統計
          const monthlyStats = computed(() => {
            const stats = { income: 0, expense: 0 };
            filteredTransactions.value.forEach((t) => {
              if (t.type === "income") stats.income += t.amount;
              else stats.expense += t.amount;
            });
            return stats;
          });

          // 方法：新增交易
          const addTransaction = () => {
            const newTx = {
              id: Date.now(),
              ...form.value,
            };
            transactions.value.unshift(newTx); // 加在最前面

            // 重置表單，保留日期方便連續輸入
            form.value.amount = "";
            form.value.note = "";
            alert("已儲存！");
          };

          // 方法：刪除交易
          const deleteTransaction = (id) => {
            if (confirm("確定刪除此筆紀錄？")) {
              transactions.value = transactions.value.filter(
                (t) => t.id !== id
              );
            }
          };

          // 方法：取得 Icon Class
          const getCategoryIcon = (cat) => {
            const map = {
              飲食: "fa-utensils",
              交通: "fa-bus",
              娛樂: "fa-gamepad",
              購物: "fa-bag-shopping",
              居住: "fa-house",
              醫療: "fa-briefcase-medical",
              薪水: "fa-money-bill-wave",
              投資: "fa-chart-line",
              其他: "fa-circle-question",
            };
            return `fa-solid ${map[cat] || "fa-tag"}`;
          };

          // 方法：渲染圖表 (Chart.js)
          const renderChart = () => {
            const ctx = document.getElementById("expenseChart");
            if (!ctx) return;

            // 銷毀舊圖表
            if (chartInstance) chartInstance.destroy();

            // 準備數據
            const catStats = {};
            filteredTransactions.value.forEach((t) => {
              if (t.type === "expense") {
                catStats[t.category] = (catStats[t.category] || 0) + t.amount;
              }
            });

            const labels = Object.keys(catStats);
            const data = Object.values(catStats);

            // 繪製
            chartInstance = new Chart(ctx, {
              type: "doughnut",
              data: {
                labels: labels,
                datasets: [
                  {
                    data: data,
                    backgroundColor: [
                      "#FF6384",
                      "#36A2EB",
                      "#FFCE56",
                      "#4BC0C0",
                      "#9966FF",
                      "#FF9F40",
                    ],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: "bottom" },
                },
              },
            });
          };

          return {
            currentTab,
            transactions,
            form,
            categories,
            searchKeyword,
            filterDate,
            pageTitle,
            isValidForm,
            filteredTransactions,
            monthlyStats,
            addTransaction,
            deleteTransaction,
            getCategoryIcon,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
