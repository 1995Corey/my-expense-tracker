<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <!-- Viewport è¨­å®šï¼šç¢ºä¿åœ¨ iPhone ä¸Šæ»¿ç‰ˆä¸”ä¸æœƒèª¤è§¸ç¸®æ”¾ -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />

    <!-- PWA æ ¸å¿ƒè¨­å®š -->
    <title>éš¨æ‰‹è¨˜å¸³ Pro</title>
    <link rel="manifest" href="manifest.json" />

    <!-- iOS å°ˆå±¬ PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- éš±è— Safari ç¶²å€åˆ— -->
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <!-- ç‹€æ…‹åˆ—é€æ˜èåˆ -->
    <meta name="apple-mobile-web-app-title" content="è¨˜å¸³Pro" />

    <!-- App åœ–ç¤º (è«‹æº–å‚™ä¸€å¼µ icon.png æ”¾åœ¨åŒç›®éŒ„ï¼Œå»ºè­° 512x512 æˆ– 192x192) -->
    <link rel="apple-touch-icon" href="icon.png" />

    <!-- è³‡æºè¼‰å…¥ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      body {
        -webkit-tap-highlight-color: transparent;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      input[type="date"],
      input[type="month"],
      input[type="number"],
      input[type="text"],
      select {
        -webkit-appearance: none;
        appearance: none;
      }
      input:focus::placeholder {
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      /* iPhone å®‰å…¨å€åŸŸè¨­å®š (ç€æµ·èˆ‡åº•éƒ¨æ©«æ¢) */
      .safe-area-pt {
        padding-top: env(safe-area-inset-top);
      }
      .safe-area-pb {
        padding-bottom: env(safe-area-inset-bottom);
      }
    </style>
  </head>
  <body
    class="bg-gray-100 text-gray-800 h-[100dvh] w-full overflow-hidden flex flex-col"
  >
    <div
      id="app"
      class="flex flex-col h-full w-full max-w-md mx-auto bg-white shadow-2xl relative"
    >
      <!-- Header å¢åŠ  safe-area-pt ä»¥é¿é–‹ç€æµ· -->
      <header
        class="bg-blue-600 text-white p-4 text-center font-bold shadow-md z-30 shrink-0 safe-area-pt pt-4"
      >
        {{ pageTitle }}
      </header>

      <main
        class="flex-1 overflow-y-auto p-4 pb-28 no-scrollbar w-full bg-gray-50"
      >
        <!-- é é¢ï¼šè¨˜å¸³ (Add) -->
        <div v-if="currentTab === 'add'" class="space-y-5 fade-in">
          <div class="flex bg-gray-200 p-1 rounded-lg shrink-0">
            <button
              @click="setFormType('expense')"
              :class="{'bg-white text-red-500 shadow': form.type === 'expense'}"
              class="flex-1 py-2 rounded-md transition-all font-bold text-sm"
            >
              æ”¯å‡º
            </button>
            <button
              @click="setFormType('income')"
              :class="{'bg-white text-green-500 shadow': form.type === 'income'}"
              class="flex-1 py-2 rounded-md transition-all font-bold text-sm"
            >
              æ”¶å…¥
            </button>
            <button
              @click="setFormType('transfer')"
              :class="{'bg-white text-purple-500 shadow': form.type === 'transfer'}"
              class="flex-1 py-2 rounded-md transition-all font-bold text-sm"
            >
              è½‰å¸³
            </button>
          </div>

          <div class="text-center py-2">
            <label class="block text-xs text-gray-500 mb-1">é‡‘é¡</label>
            <input
              type="number"
              v-model.number="form.amount"
              placeholder="0"
              class="text-5xl font-bold text-center w-full outline-none bg-transparent border-b-2 border-blue-200 focus:border-blue-500 py-2 transition-colors input-mode-decimal"
            />
          </div>

          <div class="space-y-3 w-full">
            <div class="w-full">
              <label class="block text-xs text-gray-500 mb-1">æ—¥æœŸ</label>
              <input
                type="date"
                v-model="form.date"
                class="w-full min-w-0 p-3 bg-white rounded-lg border border-gray-200 outline-none focus:border-blue-500 text-sm shadow-sm"
              />
            </div>

            <div class="grid grid-cols-2 gap-3" v-if="form.type === 'transfer'">
              <div>
                <label class="block text-xs text-gray-500 mb-1">è½‰å‡ºå¸³æˆ¶</label>
                <select
                  v-model="form.fromAccount"
                  class="w-full p-3 bg-white rounded-lg border border-gray-200 outline-none text-sm shadow-sm"
                >
                  <option v-for="acc in accounts" :key="acc.id" :value="acc.id">
                    {{ acc.name }}
                  </option>
                </select>
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1">è½‰å…¥å¸³æˆ¶</label>
                <select
                  v-model="form.toAccount"
                  class="w-full p-3 bg-white rounded-lg border border-gray-200 outline-none text-sm shadow-sm"
                >
                  <option v-for="acc in accounts" :key="acc.id" :value="acc.id">
                    {{ acc.name }}
                  </option>
                </select>
              </div>
            </div>

            <div v-else>
              <label class="block text-xs text-gray-500 mb-1"
                >æ”¯ä»˜/å…¥å¸³å¸³æˆ¶</label
              >
              <select
                v-model="form.fromAccount"
                class="w-full p-3 bg-white rounded-lg border border-gray-200 outline-none text-sm shadow-sm"
              >
                <option v-for="acc in accounts" :key="acc.id" :value="acc.id">
                  {{ acc.name }}
                </option>
              </select>
            </div>

            <div class="w-full">
              <label class="block text-xs text-gray-500 mb-1"
                >å‚™è¨» (é¸å¡«)</label
              >
              <input
                type="text"
                v-model="form.note"
                placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€è–ªæ°´..."
                class="w-full min-w-0 p-3 bg-white rounded-lg border border-gray-200 outline-none focus:border-blue-500 text-sm shadow-sm"
              />
            </div>
          </div>

          <div v-if="form.type !== 'transfer'">
            <label class="block text-xs text-gray-500 mb-2">é¸æ“‡åˆ†é¡</label>
            <div class="grid grid-cols-4 gap-2">
              <div
                v-for="cat in currentCategories"
                :key="cat"
                @click="form.category = cat"
                :class="getCategoryClass(cat)"
                class="p-2 text-center text-xs rounded-lg border cursor-pointer select-none transition-all truncate shadow-sm"
              >
                {{ cat }}
              </div>
            </div>
          </div>

          <button
            @click="addTransaction"
            :disabled="!isValidForm"
            class="w-full py-3.5 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed mt-4 mb-6"
          >
            å„²å­˜ç´€éŒ„
          </button>
        </div>

        <!-- é é¢ï¼šæ˜ç´° (List) -->
        <div v-if="currentTab === 'list'" class="space-y-4">
          <div
            class="flex gap-2 sticky top-0 bg-gray-50 z-20 py-2 border-b border-gray-200"
          >
            <input
              type="month"
              v-model="filterDate"
              class="w-1/3 min-w-0 p-2 border rounded-lg text-xs bg-white shadow-sm"
            />
            <input
              type="text"
              v-model="searchKeyword"
              placeholder="æœå°‹..."
              class="flex-1 min-w-0 p-2 border rounded-lg text-xs outline-none focus:border-blue-500 bg-white shadow-sm"
            />
          </div>

          <div
            v-if="filteredTransactions.length === 0"
            class="text-center text-gray-400 mt-10"
          >
            <i class="fa-solid fa-receipt text-4xl mb-2"></i>
            <p class="text-sm">æ²’æœ‰ç›¸é—œç´€éŒ„</p>
          </div>

          <div
            v-for="tx in filteredTransactions"
            :key="tx.id"
            class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center"
          >
            <div class="flex items-center gap-3 overflow-hidden">
              <div
                :class="getIconBgColor(tx.type)"
                class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 text-white"
              >
                <i :class="getIconClass(tx)" class="text-sm"></i>
              </div>
              <div class="min-w-0">
                <div class="font-bold text-gray-700 text-sm truncate">
                  <span v-if="tx.type === 'transfer'"
                    >è½‰å¸³: {{ getAccountName(tx.toAccount) }}</span
                  >
                  <span v-else>{{ tx.category }}</span>
                </div>
                <div class="text-xs text-gray-400 truncate">
                  {{ tx.date.slice(5) }} Â·
                  <span v-if="tx.type === 'transfer'"
                    >{{ getAccountName(tx.fromAccount) }}
                    <i class="fa-solid fa-arrow-right text-[10px]"></i
                  ></span>
                  <span v-else>{{ getAccountName(tx.fromAccount) }}</span>
                  <span v-if="tx.note"> Â· {{ tx.note }}</span>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <div :class="getAmountColor(tx.type)" class="font-bold text-base">
                {{ getAmountPrefix(tx.type) }}{{ tx.amount }}
              </div>
              <button
                @click="deleteTransaction(tx.id)"
                class="text-gray-300 hover:text-red-500 p-1"
              >
                <i class="fa-solid fa-trash text-xs"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- é é¢ï¼šåˆ†æ (Stats) -->
        <div v-if="currentTab === 'stats'" class="space-y-6">
          <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <h3 class="font-bold text-gray-700 mb-3 text-sm border-b pb-2">
              ğŸ’° ç›®å‰è³‡ç”¢åˆ†ä½ˆ
            </h3>
            <div class="grid grid-cols-2 gap-3">
              <div
                v-for="acc in accountBalances"
                :key="acc.id"
                class="bg-gray-50 p-2 rounded-lg"
              >
                <div class="text-xs text-gray-500">{{ acc.name }}</div>
                <div
                  :class="acc.balance < 0 ? 'text-red-500' : 'text-blue-600'"
                  class="font-bold truncate"
                >
                  $ {{ acc.balance }}
                </div>
              </div>
              <div
                class="col-span-2 bg-blue-50 p-2 rounded-lg flex justify-between items-center"
              >
                <div class="text-xs text-gray-500 font-bold">æ·¨è³‡ç”¢ç¸½é¡</div>
                <div class="font-bold text-blue-700 text-lg">
                  $ {{ totalNetWorth }}
                </div>
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <h3 class="font-bold text-gray-700 text-sm px-1">
              ğŸ“… æœ¬æœˆæ”¶æ”¯ ({{ filterDate }})
            </h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-green-50 p-3 rounded-xl border border-green-100">
                <div class="text-xs text-gray-500">æ”¶å…¥</div>
                <div class="text-lg font-bold text-green-600 truncate">
                  +{{ monthlyStats.income }}
                </div>
              </div>
              <div class="bg-red-50 p-3 rounded-xl border border-red-100">
                <div class="text-xs text-gray-500">æ”¯å‡º</div>
                <div class="text-lg font-bold text-red-600 truncate">
                  -{{ monthlyStats.expense }}
                </div>
              </div>
            </div>
            <div
              class="bg-gray-100 p-2 rounded-lg text-center text-xs text-gray-500"
            >
              æœ¬æœˆæ·¨æµé‡ï¼š<span
                :class="monthlyStats.net >= 0 ? 'text-blue-600' : 'text-red-600'"
                class="font-bold text-sm"
                >{{ monthlyStats.net }}</span
              >
            </div>
          </div>

          <div
            class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"
            v-show="monthlyStats.expense > 0"
          >
            <h3 class="font-bold text-gray-700 mb-2 text-center text-sm">
              æ”¯å‡ºåˆ†é¡ä½”æ¯”
            </h3>
            <div class="relative h-56 w-full">
              <canvas id="expenseChart"></canvas>
            </div>
          </div>
        </div>
      </main>

      <!-- åº•éƒ¨å°èˆª -->
      <nav
        class="bg-white border-t border-gray-200 flex justify-around items-center py-2 pb-6 safe-area-pb z-30 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]"
      >
        <button
          @click="currentTab = 'add'"
          :class="currentTab === 'add' ? 'text-blue-600 scale-110' : 'text-gray-400'"
          class="flex flex-col items-center w-1/3 transition-all p-1"
        >
          <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
          <span class="text-[10px] font-medium">è¨˜å¸³</span>
        </button>
        <button
          @click="currentTab = 'list'"
          :class="currentTab === 'list' ? 'text-blue-600 scale-110' : 'text-gray-400'"
          class="flex flex-col items-center w-1/3 transition-all p-1"
        >
          <i class="fa-solid fa-list text-xl mb-1"></i>
          <span class="text-[10px] font-medium">æ˜ç´°</span>
        </button>
        <button
          @click="currentTab = 'stats'"
          :class="currentTab === 'stats' ? 'text-blue-600 scale-110' : 'text-gray-400'"
          class="flex flex-col items-center w-1/3 transition-all p-1"
        >
          <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
          <span class="text-[10px] font-medium">åˆ†æ</span>
        </button>
      </nav>
    </div>

    <script>
      // PWA Service Worker è¨»å†Š
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("sw.js")
            .then((reg) => console.log("SW registered!", reg))
            .catch((err) => console.log("SW registration failed", err));
        });
      }

      const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

      createApp({
        setup() {
          const currentTab = ref("add");
          const transactions = ref([]);
          const searchKeyword = ref("");
          const filterDate = ref(new Date().toISOString().slice(0, 7));

          const accounts = ref([
            { id: "cash", name: "ç¾é‡‘" },
            { id: "bank", name: "éŠ€è¡Œå¸³æˆ¶" },
            { id: "credit_card", name: "ä¿¡ç”¨å¡" },
            { id: "stock", name: "è‚¡ç¥¨äº¤å‰²æˆ¶" },
          ]);

          const form = ref({
            type: "expense",
            amount: "",
            date: new Date().toISOString().slice(0, 10),
            category: "é£²é£Ÿ",
            note: "",
            fromAccount: "cash",
            toAccount: "bank",
          });

          const expenseCategories = [
            "é£²é£Ÿ",
            "äº¤é€š",
            "å¨›æ¨‚",
            "è³¼ç‰©",
            "å±…ä½",
            "é†«ç™‚",
            "æ•™è‚²",
            "å…¶ä»–",
          ];
          const incomeCategories = ["è–ªæ°´", "çé‡‘", "æŠ•è³‡", "å…¼è·", "å…¶ä»–"];
          let chartInstance = null;

          onMounted(() => {
            // è³‡æ–™æ•‘æ´èˆ‡è®€å–é‚è¼¯
            const savedDataV2 = localStorage.getItem(
              "my_expense_tracker_data_v2"
            );
            if (savedDataV2) {
              transactions.value = JSON.parse(savedDataV2);
            } else {
              const savedDataOld = localStorage.getItem(
                "my_expense_tracker_data"
              );
              if (savedDataOld) {
                try {
                  const oldTransactions = JSON.parse(savedDataOld);
                  transactions.value = oldTransactions.map((t) => ({
                    ...t,
                    fromAccount: "cash",
                    toAccount: "",
                  }));
                } catch (e) {
                  console.error(e);
                }
              }
            }
          });

          watch(
            transactions,
            (newVal) => {
              localStorage.setItem(
                "my_expense_tracker_data_v2",
                JSON.stringify(newVal)
              );
            },
            { deep: true }
          );

          watch([currentTab, filterDate], async () => {
            if (currentTab.value === "stats") {
              await nextTick();
              renderChart();
            }
          });

          const currentCategories = computed(() =>
            form.value.type === "income" ? incomeCategories : expenseCategories
          );

          const isValidForm = computed(() => {
            const basic =
              form.value.amount > 0 &&
              form.value.date &&
              form.value.fromAccount;
            if (form.value.type === "transfer")
              return (
                basic &&
                form.value.toAccount &&
                form.value.fromAccount !== form.value.toAccount
              );
            return basic && form.value.category;
          });

          const pageTitle = computed(
            () =>
              ({ add: "æ–°å¢è¨˜å¸³", list: "äº¤æ˜“æ˜ç´°", stats: "è³‡ç”¢åˆ†æ" }[
                currentTab.value
              ])
          );

          const filteredTransactions = computed(() => {
            return transactions.value
              .filter((t) => {
                const matchDate = t.date.startsWith(filterDate.value);
                const matchSearch =
                  (t.note && t.note.includes(searchKeyword.value)) ||
                  (t.category && t.category.includes(searchKeyword.value));
                return matchDate && matchSearch;
              })
              .sort(
                (a, b) => new Date(b.date) - new Date(a.date) || b.id - a.id
              );
          });

          const monthlyStats = computed(() => {
            let income = 0,
              expense = 0;
            filteredTransactions.value.forEach((t) => {
              if (t.type === "income") income += t.amount;
              if (t.type === "expense") expense += t.amount;
            });
            return { income, expense, net: income - expense };
          });

          const accountBalances = computed(() => {
            const bals = accounts.value.map((acc) => ({ ...acc, balance: 0 }));
            transactions.value.forEach((t) => {
              const fromAcc = bals.find((a) => a.id === t.fromAccount);
              const toAcc = bals.find((a) => a.id === t.toAccount);

              if (t.type === "expense" && fromAcc) fromAcc.balance -= t.amount;
              else if (t.type === "income" && fromAcc)
                fromAcc.balance += t.amount;
              else if (t.type === "transfer") {
                if (fromAcc) fromAcc.balance -= t.amount;
                if (toAcc) toAcc.balance += t.amount;
              }
            });
            return bals;
          });

          const totalNetWorth = computed(() =>
            accountBalances.value.reduce((sum, acc) => sum + acc.balance, 0)
          );

          const setFormType = (type) => {
            form.value.type = type;
            if (type === "income") form.value.category = incomeCategories[0];
            else if (type === "expense")
              form.value.category = expenseCategories[0];
          };

          const addTransaction = () => {
            transactions.value.unshift({ id: Date.now(), ...form.value });
            form.value.amount = "";
            form.value.note = "";
          };

          const deleteTransaction = (id) => {
            if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ"))
              transactions.value = transactions.value.filter(
                (t) => t.id !== id
              );
          };

          const getCategoryClass = (cat) => {
            const isSelected = form.value.category === cat;
            return form.value.type === "income"
              ? isSelected
                ? "bg-green-100 border-green-500 text-green-700"
                : "bg-white border-gray-200"
              : isSelected
              ? "bg-red-100 border-red-500 text-red-700"
              : "bg-white border-gray-200";
          };

          const getIconBgColor = (type) =>
            type === "expense"
              ? "bg-red-400"
              : type === "income"
              ? "bg-green-400"
              : "bg-purple-400";
          const getAmountColor = (type) =>
            type === "expense"
              ? "text-red-500"
              : type === "income"
              ? "text-green-500"
              : "text-purple-500";
          const getAmountPrefix = (type) =>
            type === "expense" ? "-" : type === "income" ? "+" : "";

          const getIconClass = (tx) => {
            if (tx.type === "transfer") return "fa-solid fa-right-left";
            const map = {
              é£²é£Ÿ: "fa-utensils",
              äº¤é€š: "fa-bus",
              å¨›æ¨‚: "fa-gamepad",
              è³¼ç‰©: "fa-bag-shopping",
              å±…ä½: "fa-house",
              é†«ç™‚: "fa-briefcase-medical",
              æ•™è‚²: "fa-book",
              è–ªæ°´: "fa-sack-dollar",
              çé‡‘: "fa-star",
              æŠ•è³‡: "fa-chart-line",
              å…¼è·: "fa-clock",
              å…¶ä»–: "fa-circle-question",
            };
            return `fa-solid ${map[tx.category] || "fa-tag"}`;
          };

          const getAccountName = (id) =>
            accounts.value.find((a) => a.id === id)?.name || id;

          const renderChart = () => {
            const ctx = document.getElementById("expenseChart");
            if (!ctx) return;
            if (chartInstance) chartInstance.destroy();

            const catStats = {};
            filteredTransactions.value.forEach((t) => {
              if (t.type === "expense")
                catStats[t.category] = (catStats[t.category] || 0) + t.amount;
            });
            const labels = Object.keys(catStats);
            if (labels.length === 0) return;

            chartInstance = new Chart(ctx, {
              type: "doughnut",
              data: {
                labels: labels,
                datasets: [
                  {
                    data: Object.values(catStats),
                    backgroundColor: [
                      "#ef4444",
                      "#f97316",
                      "#f59e0b",
                      "#84cc16",
                      "#06b6d4",
                      "#6366f1",
                      "#d946ef",
                      "#64748b",
                    ],
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "right",
                    labels: { boxWidth: 12, font: { size: 11 } },
                  },
                },
                layout: { padding: 10 },
              },
            });
          };

          return {
            currentTab,
            transactions,
            form,
            accounts,
            searchKeyword,
            filterDate,
            pageTitle,
            isValidForm,
            filteredTransactions,
            monthlyStats,
            accountBalances,
            totalNetWorth,
            currentCategories,
            setFormType,
            addTransaction,
            deleteTransaction,
            getCategoryClass,
            getIconBgColor,
            getAmountColor,
            getAmountPrefix,
            getIconClass,
            getAccountName,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
